name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}
        
    - name: Add Hetzner to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.HETZNER_SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: Deploy Database Schema
      run: |
        # Export schema if needed
        if [ ! -f "database/schema/valuta_schema.sql" ]; then
          echo "Schema file not found, please export it first"
          exit 1
        fi
        
        # Copy schema to VPS
        scp database/schema/valuta_schema.sql ${{ secrets.HETZNER_SSH_USER }}@${{ secrets.HETZNER_SERVER_IP }}:/tmp/valuta_schema.sql
        
        # Import database on VPS
        ssh ${{ secrets.HETZNER_SSH_USER }}@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          export PGPASSWORD='${{ secrets.DB_PASSWORD }}'
          
          # Drop and recreate database
          psql -h localhost -U ${{ secrets.DB_USERNAME }} -d postgres -c "DROP DATABASE IF EXISTS ${{ secrets.DB_NAME }};"
          psql -h localhost -U ${{ secrets.DB_USERNAME }} -d postgres -c "CREATE DATABASE ${{ secrets.DB_NAME }};"
          
          # Import schema
          psql -h localhost -U ${{ secrets.DB_USERNAME }} -d ${{ secrets.DB_NAME }} -f /tmp/valuta_schema.sql
          
          unset PGPASSWORD
        EOF
        
    - name: Deploy Backend
      run: |
        ssh ${{ secrets.HETZNER_SSH_USER }}@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          cd /var/www/valutavalto
          
          # Pull latest code
          git pull origin main || git pull origin master
          
          # Build and restart backend
          cd backend
          mvn clean package -DskipTests
          docker-compose down
          docker-compose up -d --build
        EOF

