name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Setup VPS Environment
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'SETUP_EOF'
          set -e
          echo "=== Setting up VPS Environment ==="

          if ! command -v psql &> /dev/null; then
            echo "Installing PostgreSQL..."
            apt-get update
            apt-get install -y postgresql postgresql-contrib
            systemctl start postgresql
            systemctl enable postgresql
            echo "PostgreSQL installed"
          else
            echo "PostgreSQL already installed"
          fi

          if ! command -v java &> /dev/null; then
            echo "Installing Java 17..."
            apt-get install -y openjdk-17-jdk
            echo "Java installed"
          else
            echo "Java already installed"
          fi

          if ! command -v mvn &> /dev/null; then
            echo "Installing Maven..."
            apt-get install -y maven
            echo "Maven installed"
          else
            echo "Maven already installed"
          fi

          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            apt-get install -y nginx
            systemctl start nginx
            systemctl enable nginx
            echo "Nginx installed"
          else
            echo "Nginx already installed"
          fi

          if ! command -v git &> /dev/null; then
            echo "Installing Git..."
            apt-get install -y git
            echo "Git installed"
          else
            echo "Git already installed"
          fi

          mkdir -p /var/www/valutavalto
          echo "=== VPS Environment Ready ==="
        SETUP_EOF

    - name: Setup PostgreSQL Database User
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          sudo -u postgres psql -c "DO \$\$ BEGIN IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '"'"'${{ secrets.DB_USERNAME }}'"'"') THEN CREATE USER ${{ secrets.DB_USERNAME }} WITH PASSWORD '"'"'${{ secrets.DB_PASSWORD }}'"'"'; END IF; END \$\$;"
          sudo -u postgres psql -c "ALTER USER ${{ secrets.DB_USERNAME }} WITH PASSWORD '${{ secrets.DB_PASSWORD }}';"
          sudo -u postgres psql -c "ALTER USER ${{ secrets.DB_USERNAME }} CREATEDB;"
          echo "PostgreSQL user configured"
        EOF

    - name: Deploy Database Schema
      run: |
        if [ ! -f "database/schema/valuta_schema.sql" ]; then
          echo "Schema file not found, skipping database deploy"
          exit 0
        fi

        scp database/schema/valuta_schema.sql ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }}:/tmp/valuta_schema.sql

        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          export PGPASSWORD='${{ secrets.DB_PASSWORD }}'

          echo "Dropping existing database..."
          psql -h localhost -U ${{ secrets.DB_USERNAME }} -d postgres -c "DROP DATABASE IF EXISTS ${{ secrets.DB_NAME }};" || true

          echo "Creating new database..."
          psql -h localhost -U ${{ secrets.DB_USERNAME }} -d postgres -c "CREATE DATABASE ${{ secrets.DB_NAME }};" || exit 1

          echo "Importing schema..."
          psql -h localhost -U ${{ secrets.DB_USERNAME }} -d ${{ secrets.DB_NAME }} -f /tmp/valuta_schema.sql || exit 1

          echo "Database deployed successfully!"
          rm -f /tmp/valuta_schema.sql
          unset PGPASSWORD
        EOF

    - name: Deploy Backend
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          cd /var/www/valutavalto

          if [ ! -d ".git" ]; then
            echo "Cloning repository..."
            cd /var/www
            rm -rf valutavalto
            git clone https://github.com/kosazoltan/valutavalto-program.git valutavalto
            cd valutavalto
          else
            echo "Pulling latest code..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
          fi

          echo "Building backend..."
          cd backend
          mvn clean package -DskipTests
          echo "Maven build completed"

          echo "Backend deployment completed!"
        EOF

    - name: Create Backend Service
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          if [ ! -f /etc/systemd/system/valutavalto-backend.service ]; then
            echo "Creating systemd service..."
            tee /etc/systemd/system/valutavalto-backend.service > /dev/null << 'SERVICEFILE'
        [Unit]
        Description=Valutavalto Backend Service
        After=network.target postgresql.service

        [Service]
        Type=simple
        User=root
        WorkingDirectory=/var/www/valutavalto/backend
        ExecStart=/usr/bin/java -jar target/valuta-0.0.1-SNAPSHOT.jar
        Restart=always
        RestartSec=10

        [Install]
        WantedBy=multi-user.target
        SERVICEFILE
            systemctl daemon-reload
            systemctl enable valutavalto-backend
          fi

          systemctl restart valutavalto-backend || systemctl start valutavalto-backend
          echo "Backend service started"
        EOF

    - name: Setup Node.js for Frontend Build
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Frontend
      run: |
        cd frontend-react
        npm ci
        npm run build
        echo "Frontend build completed!"

    - name: Deploy Frontend
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'mkdir -p /var/www/valutavalto/frontend-react/dist'
        scp -r frontend-react/dist/* ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }}:/var/www/valutavalto/frontend-react/dist/
        echo "Frontend files copied!"

    - name: Configure Nginx
      run: |
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          tee /etc/nginx/sites-available/valutavalto > /dev/null << 'NGINXCONF'
        server {
            listen 80;
            server_name _;

            root /var/www/valutavalto/frontend-react/dist;
            index index.html;

            # Frontend - SPA routing
            location / {
                try_files $uri $uri/ /index.html;
            }

            # Backend API proxy
            location /api {
                proxy_pass http://localhost:8080;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
            }

            # Static files caching
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }
        NGINXCONF

          # Enable site
          ln -sf /etc/nginx/sites-available/valutavalto /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default

          # Test and reload nginx
          nginx -t && systemctl reload nginx
          echo "Nginx configured and reloaded!"
        EOF

    - name: Verify Deployment
      run: |
        echo "Waiting for services to start..."
        sleep 10
        ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_SERVER_IP }} 'bash -s' << 'EOF'
          echo "=== Deployment Status ==="
          echo "Backend service:"
          systemctl status valutavalto-backend --no-pager | head -5
          echo ""
          echo "Nginx service:"
          systemctl status nginx --no-pager | head -5
          echo ""
          echo "Testing local connection:"
          curl -s -o /dev/null -w "%{http_code}" http://localhost || echo "Frontend not responding"
          echo ""
          echo "=== Deployment Complete ==="
        EOF
